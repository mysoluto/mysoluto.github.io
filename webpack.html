<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>webpack | soluto</title>
    <meta name="description" content="A VitePress site">
    <link rel="stylesheet" href="/assets/style.b83f43f5.css">
    <link rel="modulepreload" href="/assets/app.adfffae8.js">
    <link rel="modulepreload" href="/assets/webpack.md.86efa1c4.lean.js">
    
    <meta name="twitter:title" content="webpack | soluto">
  <meta property="og:title" content="webpack | soluto">
  </head>
  <body>
    <div id="app"><div class="page"><header class="page-header"><h1>M.X</h1></header><main class="page-main"><div style="position:relative;"><div><h1 id="webpack-学习" tabindex="-1">webpack 学习 <a class="header-anchor" href="#webpack-学习" aria-hidden="true">#</a></h1><h2 id="webpack-bootstrap-源码" tabindex="-1">webpack bootstrap 源码 <a class="header-anchor" href="#webpack-bootstrap-源码" aria-hidden="true">#</a></h2><p>webpack bootstrap是 webpack打包之后的启动代码，以下部分是基于webpack 4.x的源码逻辑，在webpack 5.x中，MainTemplate文件被废弃掉了</p><p>在MainTemplate.js里面定义了 renderBootstrap方法，返回bootstrap的代码 大致如下</p><p>在window下面挂载了一个变量 <code>webpackJsonp</code>, 这个变量名可以在 output options里面可以更改，webpackJsonp是一个普通的数据，其push方法被绑定成webpackJsonpCallback</p><p>然后对chunk代码的加载，其模式是</p><div class="language-js"><pre><code><span class="token punctuation">(</span>window<span class="token punctuation">[</span><span class="token string">&#39;webpackJsonp&#39;</span><span class="token punctuation">]</span> <span class="token operator">=</span> window<span class="token punctuation">[</span><span class="token string">&#39;webpackJsonp&#39;</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">188</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>moreModules<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>exectedModules<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></div><p>因此从webpackJsonp中可以看出加载了多少个chunk, 以及所有的module模块；在实际加载chunk的时候，执行的是webpackJsonpCallback方法，参数如上，是一个多维数组</p><div class="language-js"><pre><code><span class="token keyword">function</span> <span class="token function">webpackJsonpCallback</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> chunkIds <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
  <span class="token keyword">const</span> moreModules <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
  <span class="token keyword">const</span> exectedModules <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>

  <span class="token keyword">const</span> resolves <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  chunkIds<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">chunkId</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>installedChunks<span class="token punctuation">,</span> chunkId<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      resolves<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span> <span class="token comment">// 0 标记chunk loaded</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span>m <span class="token keyword">in</span> moreModules<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>moreModules<span class="token punctuation">,</span> m<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 缓存模块</span>
      modules<span class="token punctuation">[</span>m<span class="token punctuation">]</span> <span class="token operator">=</span> moreModules<span class="token punctuation">[</span>m<span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span><span class="token punctuation">(</span>parentJsonpFunction<span class="token punctuation">)</span> <span class="token function">parentJsonpFunction</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span>resolves<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    reosolves<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  deferedModuels<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>deferedModules<span class="token punctuation">,</span> execedModules<span class="token punctuation">)</span>

  <span class="token keyword">return</span> <span class="token function">checkDeferredModules</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>下载chunk js文件，然后执行上面的webpackJsonpCallback函数，缓存chunk里面包含的module，后面代码执行的时候，实际通过<code>__webpack_require__(moduleId)</code> 加载模块，类似于源码里面的 <code>const vue = require(&#39;vue&#39;)</code></p><p>在__webpack_require__，执行具体的模块加载逻辑，该function下面也挂载了一些扩展extension方法，比如（<strong>webpack_require</strong>.s, <strong>webpack_require</strong>.c等），其中比较重要的是 <code>__webpack_require__.e</code>, 增加script标签来加载chunk js文件，chunk js的路径通过jsonpScriptSrc方法获取</p><div class="language-js"><pre><code><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">modules</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">function</span> <span class="token function">webpackJsonpCallback</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">checkDeferredModules</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token keyword">var</span> installedModules <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

  <span class="token keyword">var</span> installedChunks <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token keyword">var</span> installedCssChunks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

  <span class="token keyword">function</span> <span class="token function">jsonpScriptSrc</span><span class="token punctuation">(</span><span class="token parameter">chunkId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token parameter">moduleId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token comment">// require function shortcuts:</span>
  <span class="token comment">// __webpack_require__.s = the module id of the entry point</span>
  <span class="token comment">// __webpack_require__.c = the module cache</span>
  <span class="token comment">// __webpack_require__.m = the module functions</span>
  <span class="token comment">// __webpack_require__.p = the bundle public path</span>
  <span class="token comment">// __webpack_require__.i = the identity function used for harmony imports</span>
  <span class="token comment">// __webpack_require__.e = the chunk ensure function</span>
  <span class="token comment">// __webpack_require__.d = the exported property define getter function</span>
  <span class="token comment">// __webpack_require__.o = Object.prototype.hasOwnProperty.call</span>
  <span class="token comment">// __webpack_require__.r = define compatibility on export</span>
  <span class="token comment">// __webpack_require__.t = create a fake namespace object</span>
  <span class="token comment">// __webpack_require__.n = compatibility get default export</span>
  <span class="token comment">// __webpack_require__.h = the webpack hash</span>
  <span class="token comment">// __webpack_require__.w = an object containing all installed WebAssembly.Instance export objects keyed by module id</span>
  <span class="token comment">// __webpack_require__.oe = the uncaught error handler for the webpack runtime</span>
  <span class="token comment">// __webpack_require__.nc = the script nonce</span>

  <span class="token keyword">var</span> jsonpArray <span class="token operator">=</span> window<span class="token punctuation">[</span><span class="token string">&#39;webpackJsonp&#39;</span><span class="token punctuation">]</span> <span class="token operator">=</span> window<span class="token punctuation">[</span><span class="token string">&#39;webpackJsonp&#39;</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token keyword">var</span> jsonpOldFunction <span class="token operator">=</span> jsonpArray<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>jsonpArray<span class="token punctuation">)</span>
  jsonpArray<span class="token punctuation">.</span>push <span class="token operator">=</span> webpackJsonpCallback
  jsonpArray <span class="token operator">=</span> jsonpArray<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token punctuation">;</span> <span class="token keyword">var</span> i <span class="token operator">&lt;</span> jsonpArray<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">webpackJsonpCallback</span><span class="token punctuation">(</span>jsonpArray<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">var</span> parentJsonpFunction <span class="token operator">=</span> jsonpOldFunction

  <span class="token function">checkDeferredModules</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></div></div></div></main></div></div>
    <script>__VP_HASH_MAP__ = JSON.parse("{\"index.md\":\"8b967e31\",\"nodejs_memory.md\":\"2e550f1a\",\"probolem.md\":\"af408a9b\",\"vite.md\":\"a0f05bd4\",\"webpack.md\":\"86efa1c4\"}")</script>
    <script type="module" async src="/assets/app.adfffae8.js"></script>
    
  </body>
</html>